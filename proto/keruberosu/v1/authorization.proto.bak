syntax = "proto3";

package keruberosu.v1;

import "google/protobuf/struct.proto";
import "keruberosu/v1/common.proto";

option go_package = "github.com/asakaida/keruberosu/proto/keruberosu/v1;keruberosupb";

// ========================================
// Permission Service (Permify互換)
// 権限チェック関連の操作
// ========================================

service Permission {
  rpc Check(PermissionCheckRequest) returns (PermissionCheckResponse);
  rpc Expand(PermissionExpandRequest) returns (PermissionExpandResponse);
  rpc LookupEntity(PermissionLookupEntityRequest) returns (PermissionLookupEntityResponse);
  rpc LookupSubject(PermissionLookupSubjectRequest) returns (PermissionLookupSubjectResponse);
  rpc LookupEntityStream(PermissionLookupEntityRequest) returns (stream PermissionLookupEntityStreamResponse);
  rpc SubjectPermission(PermissionSubjectPermissionRequest) returns (PermissionSubjectPermissionResponse);
}

// ========================================
// Data Service (Permify互換)
// データの書き込み・読み取り・削除
// ========================================

service Data {
  // Permify互換: tuples と attributes を同時に書き込み
  rpc Write(DataWriteRequest) returns (DataWriteResponse);
  rpc Delete(DataDeleteRequest) returns (DataDeleteResponse);
  rpc Read(DataReadRequest) returns (DataReadResponse);
  rpc ReadAttributes(AttributeReadRequest) returns (AttributeReadResponse);
}

// ========================================
// Schema Service (Permify互換)
// スキーマ管理
// ========================================

service Schema {
  rpc Write(SchemaWriteRequest) returns (SchemaWriteResponse);
  rpc Read(SchemaReadRequest) returns (SchemaReadResponse);
}

// ========================================
// Permission Service Messages
// ========================================

message PermissionCheckRequest {
  PermissionCheckMetadata metadata = 1;
  Entity entity = 2;
  string permission = 3;
  Subject subject = 4;
  Context context = 5;
  repeated google.protobuf.Value arguments = 6;
}

message PermissionCheckResponse {
  CheckResult can = 1;
  PermissionCheckResponseMetadata metadata = 2;
}

message PermissionCheckResponseMetadata {
  int32 check_count = 1;
}

message PermissionExpandRequest {
  PermissionCheckMetadata metadata = 1;
  Entity entity = 2;
  string permission = 3;
  Context context = 4;
  repeated google.protobuf.Value arguments = 5;
}

message PermissionExpandResponse {
  Expand tree = 1;
}

message PermissionLookupEntityRequest {
  PermissionCheckMetadata metadata = 1;
  string entity_type = 2;
  string permission = 3;
  Subject subject = 4;
  Context context = 5;
  int32 page_size = 6;
  string continuous_token = 7;
}

message PermissionLookupEntityResponse {
  repeated string entity_ids = 1;
  string continuous_token = 2;
}

message PermissionLookupEntityStreamResponse {
  string entity_id = 1;
  string continuous_token = 2;
}

message PermissionLookupSubjectRequest {
  PermissionCheckMetadata metadata = 1;
  Entity entity = 2;
  string permission = 3;
  SubjectReference subject_reference = 4;
  Context context = 5;
  int32 page_size = 6;
  string continuous_token = 7;
}

message PermissionLookupSubjectResponse {
  repeated string subject_ids = 1;
  string continuous_token = 2;
}

message PermissionSubjectPermissionRequest {
  PermissionCheckMetadata metadata = 1;
  Entity entity = 2;
  Subject subject = 3;
  Context context = 4;
}

message PermissionSubjectPermissionResponse {
  map<string, CheckResult> results = 1;
}

// ========================================
// Data Service Messages
// ========================================

// Permify互換: tuples と attributes を同時に書き込み可能
message DataWriteRequest {
  DataWriteRequestMetadata metadata = 1;
  repeated Tuple tuples = 2;
  repeated Attribute attributes = 3;
}

message DataWriteRequestMetadata {
  string schema_version = 1;  // 将来実装予定
}

message DataWriteResponse {
  string snap_token = 1;  // 将来実装予定
}

// Permify互換: フィルター形式で削除
message DataDeleteRequest {
  TupleFilter filter = 1;
}

message DataDeleteResponse {
  string snap_token = 1;  // 将来実装予定
}

// Permify互換: フィルター + ページネーションで読み取り
message DataReadRequest {
  PermissionCheckMetadata metadata = 1;
  TupleFilter filter = 2;
  int32 page_size = 3;
  string continuous_token = 4;
}

message DataReadResponse {
  repeated Tuple tuples = 1;
  string continuous_token = 2;
}

message AttributeReadRequest {
  PermissionCheckMetadata metadata = 1;
  AttributeFilter filter = 2;
  int32 page_size = 3;
  string continuous_token = 4;
}

message AttributeReadResponse {
  repeated Attribute attributes = 1;
  string continuous_token = 2;
}

// ========================================
// Schema Service Messages
// ========================================

message SchemaWriteRequest {
  string schema = 1;  // Permify互換: schema_dsl → schema
}

message SchemaWriteResponse {
  string schema_version = 1;  // 将来実装予定
}

message SchemaReadRequest {
  PermissionCheckMetadata metadata = 1;
}

message SchemaReadResponse {
  string schema = 1;  // Permify互換: schema_dsl → schema
  string updated_at = 2;
}

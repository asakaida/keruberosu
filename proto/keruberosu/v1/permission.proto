syntax = "proto3";

package keruberosu.v1;

import "google/protobuf/struct.proto";
import "keruberosu/v1/common.proto";

option go_package = "github.com/asakaida/keruberosu/proto/keruberosu/v1;keruberosupb";

// ========================================
// Permission Service (Permify互換)
// 権限チェック関連の操作
// ========================================

service Permission {
  rpc Check(PermissionCheckRequest) returns (PermissionCheckResponse);
  rpc Expand(PermissionExpandRequest) returns (PermissionExpandResponse);
  rpc LookupEntity(PermissionLookupEntityRequest) returns (PermissionLookupEntityResponse);
  rpc LookupSubject(PermissionLookupSubjectRequest) returns (PermissionLookupSubjectResponse);
  rpc LookupEntityStream(PermissionLookupEntityRequest) returns (stream PermissionLookupEntityStreamResponse);
  rpc SubjectPermission(PermissionSubjectPermissionRequest) returns (PermissionSubjectPermissionResponse);
}

// ========================================
// Permission Service Messages
// ========================================

message PermissionCheckRequest {
  string tenant_id = 1;
  PermissionCheckMetadata metadata = 2;
  Entity entity = 3;
  string permission = 4;
  Subject subject = 5;
  Context context = 6;
  repeated google.protobuf.Value arguments = 7;
}

message PermissionCheckResponse {
  CheckResult can = 1;
  PermissionCheckResponseMetadata metadata = 2;
}

message PermissionCheckResponseMetadata {
  int32 check_count = 1;
}

message PermissionExpandRequest {
  string tenant_id = 1;
  PermissionCheckMetadata metadata = 2;
  Entity entity = 3;
  string permission = 4;
  Context context = 5;
  repeated google.protobuf.Value arguments = 6;
}

message PermissionExpandResponse {
  Expand tree = 1;
}

message PermissionLookupEntityRequest {
  string tenant_id = 1;
  PermissionCheckMetadata metadata = 2;
  string entity_type = 3;
  string permission = 4;
  Subject subject = 5;
  Context context = 6;
  map<string, StringArrayValue> scope = 7;
  uint32 page_size = 8;
  string continuous_token = 9;
}

message PermissionLookupEntityResponse {
  repeated string entity_ids = 1;
  string continuous_token = 2;
}

message PermissionLookupEntityStreamResponse {
  string entity_id = 1;
  string continuous_token = 2;
}

message PermissionLookupSubjectRequest {
  string tenant_id = 1;
  PermissionCheckMetadata metadata = 2;
  Entity entity = 3;
  string permission = 4;
  SubjectReference subject_reference = 5;
  Context context = 6;
  uint32 page_size = 7;
  string continuous_token = 8;
}

message PermissionLookupSubjectResponse {
  repeated string subject_ids = 1;
  string continuous_token = 2;
}

message PermissionSubjectPermissionRequest {
  string tenant_id = 1;
  PermissionCheckMetadata metadata = 2;
  Entity entity = 3;
  Subject subject = 4;
  Context context = 5;
}

message PermissionSubjectPermissionResponse {
  map<string, CheckResult> results = 1;
}
